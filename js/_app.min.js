"use strict";var PostModel=Backbone.Model.extend({defaults:{date:"",title:"",cover:"",author:"",ava:"",post:""}}),PostsCollection=Backbone.Collection.extend({model:PostModel,url:"blog/data/index.json"}),BlogView=Backbone.View.extend({tagName:"section",id:"blogView",template:{source:"server",path:"js/app/templates/blog.html"},events:{"click #pagination .pageNum":"_changePage","click #pagination .next, #pagination .prev":"_togglePage"},pages:1,perPage:3,currentPage:1,initialize:function(e){this.on("rendered",this._renderPosts),this.pages=Math.ceil(this.collection.length/this.perPage),e.page&&e.page<=this.collection.length+1&&(this.currentPage=parseInt(e.page)),this.renderObj={pages:this.pages},this.el.style.minHeight=window.innerHeight+"px"},_renderPosts:function(){this.pageLinks=this.$("#pagination a"),this.postsList=new PostsListRegion,this._showPage()},_changePage:function(e){e.preventDefault(),this.currentPage=parseInt(e.currentTarget.classList[1]),this._showPage()},_showPage:function(){var e=this.currentPage*this.perPage,t=e-this.perPage,i=this.collection.slice(t,e),o=document.createElement("div");o.className="page",_.each(i,function(e){t++,o.appendChild(this.layout.createView("blogPost",{type:"short",model:e,index:t}).render())}.bind(this)),this.postsList.showNode(o,{transition:"dissolve"}),this.module.controller.navigate("blog/"+this.currentPage+"/"),this.pageLinks.filter(".active").removeClass("active"),this.pageLinks.filter("."+this.currentPage).addClass("active")},_togglePage:function(e){var t="next"==e.currentTarget.classList[0]?1:-1,i=this.currentPage+t;i&&this.pages>=i&&(this.currentPage+=t,this._showPage())}}),BlogPostView=Backbone.View.extend({tagName:"section",className:"blogPost",template:{source:"server",path:"js/app/templates/blogPostShort.html"},templates:{full:"js/app/templates/blogPost.html","short":"js/app/templates/blogPostShort.html"},events:{"click h2, .cover":"_openPost"},initialize:function(e){"full"==e.type&&(this.el.id="blogPostView"),this.template.path=this.templates[e.type]},_openPost:function(){this.el.id||this.module.controller.navigate("blog/post/"+this.options.index+"/",!0)}}),MainView=Backbone.View.extend({tagName:"section",id:"mainView",template:{source:"server",path:"js/app/templates/main.html"},events:{"click #sideNav .nav":"_scrollTo","click .popOverBlock":"_popOver","click .popOver figure":"_showImage","click #modal, #viewer":"_closeViewer","mouseover #ticketsBlock":"_ticketAnimation","mouseout #ticketsBlock":"_ticketAnimation","click .marker, .address":"_renderMap","click #map":"_stopPropagation","click #circles .popOver":"_stopPropagation"},vOffset:0,pointer:null,slides:null,clouds:null,isCloudBottomReachedFirst:!0,currentSlide:0,cache:null,initialize:function(){this.$el.on("load",function(){console.log("loaded!!!")}),this.on("rendered",function(){this._prepareSlides(),this._prepareClouds(),this.module.loaded?this._cache():this.module.on("window.loaded",this._cache.bind(this)),this.viewer=this.$("#viewer")})},scrollTo:function(e){var t=this.$(e.replace("/",""))[0],i=200,o=window.scrollY,n=this._calculateOffset(t),s=n>o?1:-1,a=10*(Math.abs(n-o)/i)*s,l=function(){o+=a,s>0&&n>o||0>s&&o>n?(window.scrollTo(0,o),setTimeout(l,10)):window.scrollTo(0,n)}.bind(this);l()},_scrollTo:function(e){e.preventDefault(),this.scrollTo(e.currentTarget.hash)},_calculateOffset:function(e){return window.innerHeight>e.offsetHeight&&e.offsetTop?Math.abs(e.offsetTop-Math.ceil((window.innerHeight-e.offsetHeight)/2)):e.offsetTop},scroll:function(e,t,i){var o=t?this.currentSlide+1:this.currentSlide-1,n=this.$slides[o];n&&(t&&e>=this._calculateOffset(n)-1||!t&&this._calculateOffset(this.$slides[this.currentSlide])-2>=e||o==this.$slides.length-1&&e>=this.el.scrollHeight-window.innerHeight)&&(this.currentSlide=o,this.module.controller.navigate(o?n.id+"/":"home/")),this._cloudsParalax(e,t,Math.abs(i)),this._commonAnimation(e,"about",.1,".stalactites"),this._commonAnimation(e,"tickets",.5,"#ticketsBlock"),this._commonAnimation(e,"venue",.7,".marker"),this.vOffset=e},_prepareSlides:function(){this.slides={},this.$slides=this.$(".slide"),this.$slides.each(function(e,t){e||(t.style.height=.9*window.innerHeight+"px"),this.slides[t.id]=t}.bind(this))},_prepareClouds:function(){var e=this.$(".cloud").toArray();this.clouds={top:0,bottom:document.documentElement.clientHeight/4,els:function(){var t=[];return _.each(e,function(e){e.classList.add("animation"),t.push({el:e,offset:e.offsetTop})}),t}()}},_prepareSideNav:function(){var e=this.$("#sideNav")[0],t=.7,i=window.innerHeight,o=e.querySelectorAll(".nav"),n=e.querySelector(".pointer");e.style.height=i*t+"px",e.style.top=(i-e.offsetHeight)/2+"px",_.each(o,function(t){var i=this.slides[t.classList[1]];t.style.top=(i.offsetTop+i.offsetHeight/2)/this.el.offsetHeight*e.offsetHeight-t.offsetHeight/2+"px"}.bind(this)),this.pointer={el:n,c:e.offsetHeight/this.el.offsetHeight,hWih:i/2,delta:0,dragging:!1},this._pointerAnimation(0),this.pointer.offset=n.offsetTop},_cloudsParalax:function(e,t,i){var o=.3;"transform"in this.el.style?"transform":"webkitTransform",e*=o,i*=o;var n=e>this.clouds.bottom;e>=this.clouds.top&&(!n||this.isCloudBottomReachedFirst)&&(t?(_.each(this.clouds.els,function(e){var t=e.el.offsetTop+i,o=e.offset+this.clouds.bottom;e.el.style.top=(o>t?t:o)+"px"}.bind(this)),n&&(this.isCloudBottomReachedFirst=!1)):(this.isCloudBottomReachedFirst=!0,_.each(this.clouds.els,function(e){var t=e.el.offsetTop-i,o=e.offset-this.clouds.top;e.el.style.top=(t>o?t:o)+"px"}.bind(this))))},_pointerAnimation:function(e){var t=this.pointer.el;t.style.top=(e+this.pointer.hWih)*this.pointer.c-t.offsetHeight/2+"px",this.pointer.delta=e},_changePointerPosition:function(e){e.preventDefault(),e.stopPropagation();var t=e.originalEvent.clientY;if(t){var i=t-this.pointer.mouseY;this.pointer.mouseY=e.originalEvent.clientY,console.log(i/this.pointer.c),window.scrollBy(0,i/this.pointer.c)}},_dragStart:function(e){this.pointer.dragging=!0,this.pointer.delta=window.scrollY,this.pointer.mouseY=e.originalEvent.clientY},_drag:function(e){this.pointer.dragging&&this._changePointerPosition(e)},_dragEnd:function(){this.pointer.dragging=!1},_commonAnimation:function(e,t,i,o){o||(o=null);var n="is"+t+"Animated";if(!this[n]){var s=this.slides[t],a=(o?s.querySelectorAll(o)[0]:s).getBoundingClientRect().top,l=window.innerHeight*i;(l>=a||this.el.scrollTop+window.innerHeight+1>=this.el.scrollHeight)&&($(s).find(".animation").addClass("end"),this[n]=!0)}},_popOver:function(e){$(e.currentTarget).toggleClass("end")},_calculateViewerStyles:function(e){var t=this.viewer[0],i=e.getBoundingClientRect(),o=i.left-.1*window.innerWidth+e.offsetWidth/2,n=i.top-.1*window.innerHeight+e.offsetHeight/2;t.style.margin=(window.innerHeight-t.offsetHeight)/2+"px 0 0 "+(window.innerWidth-t.offsetWidth)/2+"px",t.style.transformOrigin=t.style.webkitTransformOrigin=o+"px "+n+"px"},_showViewer:function(e,t){this.viewer.html(e),this._calculateViewerStyles(t),document.body.classList.toggle("modal")},_showImage:function(e){e.stopPropagation();var t=e.currentTarget.childNodes[1],i=this.cache.images[t.classList[0]];i.complete?this._onImgLoad(t,{currentTarget:i}):(this.module.preload(e.currentTarget,!0),i.onload=this._onImgLoad.bind(this,t))},_onImgLoad:function(e,t){var i=t.currentTarget;this._calculateImageOffset(i),this._showViewer(i,e),this.module.unPreload(e.parentNode)},_calculateImageOffset:function(e){var t=e.naturalWidth/e.naturalHeight,i=this.viewer[0],o=i.offsetWidth/i.offsetHeight;o>t?e.style.marginLeft=Math.abs(i.offsetWidth-i.offsetHeight*t)/2+"px":e.style.marginTop=Math.abs(i.offsetHeight-i.offsetWidth/t)/2+"px"},_closeViewer:function(){this.viewer.removeClass("show"),document.body.classList.toggle("modal")},_ticketAnimation:function(e){if(this.isticketsAnimated){var t=$(e.currentTarget).find(".animation");"mouseover"==e.type?t.addClass("hover"):t.removeClass("hover")}},_cache:function(){this.cache={};var e=document.createElement("img"),t=document.createElement("img"),i=this.module.options.cachePuncher;e.src="css/img/venue/hall_big.jpg"+i,t.src="css/img/venue/stage_big.jpg"+i,this.cache.images={hall:e,stage:t}},_renderMap:function(e){if(!this.mapEl){var t=this.mapEl=document.createElement("div");t.id="map";var i=50.449983,o=30.527936,n=new google.maps.Map(t,{zoom:17,center:new google.maps.LatLng(i,o),mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!1});new google.maps.Marker({position:new google.maps.LatLng(i,o),map:n,title:"1 Instytutska St, Kyiv",draggable:!1})}this._showViewer(this.mapEl,e.currentTarget)},_stopPropagation:function(e){e.stopPropagation()}}),NavView=Backbone.View.extend({tagName:"nav",id:"navView",template:{source:"server",path:"js/app/templates/nav.html"},events:{"click .nav":"_nav"},initialize:function(){this.on("rendered",function(){this.links=this.$(".nav, .navigation"),this.toggleActive()})},_nav:function(e){e.preventDefault();var t=this.module.controller.mainView;t?t.scrollTo(e.currentTarget.hash):this.module.controller.navigate(e.currentTarget.hash,!0)},toggleActive:function(){this.links.removeClass("active");var e=Backbone.history.fragment.split("/")[0];e&&this.$("."+e).addClass("active")}}),ContentRegion=Backbone.Region.extend({el:"#content",initialize:function(){this.on("changed",function(){this.el.style.height=this.el.scrollHeight<window.innerHeight?"100%":"auto"})}}),HeaderRegion=Backbone.Region.extend({el:"#header"}),PostsListRegion=Backbone.Region.extend({el:"#posts"}),MainController=Backbone.Controller.extend({routes:{"(home)(about)(tickets)(venue)(/)":"slide","blog(/:page)(/)":"blog","blog/post/:id(/)":"blogPost","*whatever":"notFound"},prevBodyClass:"",mainView:null,initialize:function(){this.on("started",function(){this.layout.showRegion({header:this.layout.createView("nav")})}),this.on("before",function(){this.mainView=null}),this.on("navigate",function(){var e=this.layout.getRegion("header").view;e.rendered&&e.toggleActive()})},_bodyClass:function(e){var t=document.body,i=this.prevBodyClass;i&&t.classList.remove(i),t.classList.add(e),this.prevBodyClass=e},slide:function(){this._bodyClass("home"),this.mainView=this.layout.createView("main"),this.mainView.once("rendered",function(){var e=Backbone.history.fragment;e&&this.scrollTo("#"+e)}),this.layout.showRegion({content:this.mainView},{transition:"dissolve"})},_getPosts:function(e){var t=new PostsCollection;t.on("reset",e.bind(this,t)),t.fetch({reset:!0})},blog:function(e){this._bodyClass("blog"),this._getPosts(function(t){this.layout.showRegion({content:this.layout.createView("blog",{collection:t,page:e})},{transition:"dissolve"})})},blogPost:function(e){this._bodyClass("blogPost"),this._getPosts(function(t){this.layout.showRegion({content:this.layout.createView("blogPost",{type:"full",model:t.at(e-1)})},{transition:"dissolve"})})},notFound:function(){this.navigate("",!0)}}),MainLayout=Backbone.Layout.extend({regions:{header:HeaderRegion,content:ContentRegion},views:{nav:NavView,main:MainView,blog:BlogView,blogPost:BlogPostView}}),App=Backbone.Application.extend({loaded:!1,initialize:function(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.addEventListener("progress",function(e){console.log(e.loaded,e.total)},!1),window.addEventListener("load",this._onLoad.bind(this),!1),this.on("started",this._onStarted),this.pagePreload(),this.start()},_onStarted:function(){this._bindScroll()},_onLoad:function(){this.trigger("window.loaded",window),this.pageUnPreload(),this.loaded=!0},_bindScroll:function(){var e=window.scrollY,t=e,i=0;window.addEventListener("scroll",function(){var o=this.controller.mainView;o&&(t=window.scrollY,i=t-e,e=t,o.scroll(t,i>0,Math.abs(i)))}.bind(this),!1)},_preload:function(e,t,i){t.addEventListener("click",function(e){e.stopPropagation()},!1),t.style.height=e.offsetHeight+"px",t.style.width=e.offsetWidth+"px",i&&t.classList.add("show"),e.appendChild(t),t.classList.add("animation")},_unPreload:function(e,t){var i=e.querySelector(t);if(i){var o=function(){e.removeChild(i),i.removeEventListener("webkitTransitionEnd",o),i.removeEventListener("transitionend",o)};i.addEventListener("webkitTransitionEnd",o,!1),i.addEventListener("transitionend",o,!1),requestAnimationFrame(function(){i.classList.remove("show"),i.classList.remove("animation")})}},preload:function(e,t){var i=document.createElement("div"),o=document.createElement("img");o.onload=this._spinerLoad,o.src="css/img/preloader.png",o.style.left=o.style.top="50%",i.id="preloader",i.appendChild(o),this._preload(e,i,t)},_spinerLoad:function(){this.style.margin=-this.height/2+"px 0 0 "+-this.width/2+"px"},unPreload:function(e){this._unPreload(e,"#preloader")},pagePreload:function(){var e=document.body;e.classList.add("loading");var t=document.createElement("div"),i=document.createElement("div"),o=document.createElement("img"),n=document.createElement("img"),s=document.createElement("p");o.src=n.src="css/img/eye.png",i.appendChild(o),i.appendChild(n),s.innerText="loading...",t.id="pagePreloader",t.appendChild(i),t.appendChild(s),this._preload(e,t,!0)},pageUnPreload:function(){var e=document.body;e.classList.remove("loading"),this._unPreload(e,"#pagePreloader")}});